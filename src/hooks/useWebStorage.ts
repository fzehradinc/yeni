import { useState, useEffect, useCallback } from 'react';

// Web Storage Hook - Electron yerine localStorage/IndexedDB kullanƒ±r
export const useWebStorage = () => {
  const [isReady, setIsReady] = useState(false);

  useEffect(() => {
    setIsReady(true);
  }, []);

  // JSON dosyasƒ± oku - localStorage'dan
  const readJsonFile = useCallback(async (filename: string) => {
    if (!isReady) return null;
    
    try {
      const key = filename.replace('.json', '');
      const data = localStorage.getItem(`pds_${key}`);
      console.log(`üìñ [WEB] JSON dosyasƒ± okundu: ${filename}`, data ? 'Veri var' : 'Veri yok');
      return data ? JSON.parse(data) : null;
    } catch (error) {
      console.error(`‚ùå [WEB] JSON okuma hatasƒ± (${filename}):`, error);
      return null;
    }
  }, [isReady]);

  // JSON dosyasƒ± yaz - localStorage'a
  const writeJsonFile = useCallback(async (filename: string, data: any) => {
    if (!isReady) return false;
    
    try {
      const key = filename.replace('.json', '');
      localStorage.setItem(`pds_${key}`, JSON.stringify(data));
      console.log(`üíæ [WEB] JSON dosyasƒ± kaydedildi: ${filename}`);
      return true;
    } catch (error) {
      console.error(`‚ùå [WEB] JSON yazma hatasƒ± (${filename}):`, error);
      return false;
    }
  }, [isReady]);

  // Yayƒ±n durumunu g√ºncelle
  const updateYayinDurumu = useCallback(async (moduleName: string, isPublished: boolean) => {
    if (!isReady) return false;
    
    try {
      console.log(`üöÄ [WEB] Yayƒ±n durumu g√ºncelleniyor: ${moduleName} = ${isPublished}`);
      
      // Mevcut yayƒ±n durumlarƒ±nƒ± al
      const currentData = localStorage.getItem('pds_yayinda');
      const yayinData = currentData ? JSON.parse(currentData) : {
        "TB2_TB3_Entegrasyon_Grubu": false,
        "Akinci_Entegrasyon_Grubu": false,
        "Kizilelma_Entegrasyon_Grubu": false,
        "On_Montaj_Grubu": false,
        "Kalite_Kontrol_Takimi": false,
        "Hafif_Platformlar_Takimi": false,
        "Surec_Yonetimi_Takimi": false,
        "Gelistirme_Grubu": false,
        "Surdurulebilir_Uretim_Takimi": false,
        "Saha_Operasyonlari_Ekibi": false,
        "Idari_Isler_Ekibi": false,
        "EgitimModulu": false,
        "SSSModulu": false,
        "SurecAkislari": false,
        "ProsedurTalimatlar": false
      };
      
      yayinData[moduleName] = isPublished;
      localStorage.setItem('pds_yayinda', JSON.stringify(yayinData));
      
      console.log(`üöÄ [WEB] Yayƒ±n durumu g√ºncellendi: ${moduleName} = ${isPublished}`);
      return true;
    } catch (error) {
      console.error(`‚ùå [WEB] Yayƒ±n durumu g√ºncelleme hatasƒ±:`, error);
      return false;
    }
  }, [isReady]);

  // Dosya kaydet - Base64 olarak localStorage'a
  const saveFile = useCallback(async (filename: string, data: string, encoding: string = 'utf8') => {
    if (!isReady) return false;
    
    try {
      // Dosya boyutu kontrol√º
      const dataSize = new Blob([data]).size;
      const maxSize = 2.5 * 1024 * 1024; // 2.5MB limit
      
      if (dataSize > maxSize) {
        console.warn(`‚ö†Ô∏è [WEB] Dosya boyutu sƒ±nƒ±rƒ± a≈üƒ±ldƒ±: ${(dataSize / 1024 / 1024).toFixed(1)} MB`);
        throw new Error(`Dosya √ßok b√ºy√ºk: ${(dataSize / 1024 / 1024).toFixed(1)} MB (max: 2.5 MB)`);
      }
      
      // Eski dosyalarƒ± temizle (alan a√ßmak i√ßin)
      const keys = Object.keys(localStorage);
      const fileKeys = keys.filter(key => key.startsWith('pds_file_')).sort();
      
      if (fileKeys.length > 10) { // En fazla 10 dosya tut
        const oldestKeys = fileKeys.slice(0, fileKeys.length - 10);
        oldestKeys.forEach(key => {
          localStorage.removeItem(key);
          console.log(`üóëÔ∏è [WEB] Eski dosya temizlendi: ${key}`);
        });
      }
      
      localStorage.setItem(`pds_file_${filename}`, data);
      console.log(`üíæ [WEB] Dosya kaydedildi: ${filename} (${(dataSize / 1024).toFixed(1)} KB)`);
      return true;
    } catch (error) {
      console.error(`‚ùå [WEB] Dosya kaydetme hatasƒ± (${filename}):`, error);
      
      if (error.name === 'QuotaExceededError') {
        // Acil temizlik yap
        const keys = Object.keys(localStorage);
        const fileKeys = keys.filter(key => key.startsWith('pds_file_'));
        fileKeys.forEach(key => localStorage.removeItem(key));
        
        // Tekrar dene
        try {
          localStorage.setItem(`pds_file_${filename}`, data);
          console.log(`üíæ [WEB] Dosya acil temizlik sonrasƒ± kaydedildi: ${filename}`);
          return true;
        } catch (retryError) {
          console.error(`‚ùå [WEB] Acil temizlik sonrasƒ± da ba≈üarƒ±sƒ±z:`, retryError);
          return false;
        }
      }
      
      return false;
    }
  }, [isReady]);

  // Dosya oku - localStorage'dan
  const readFile = useCallback(async (filename: string, encoding: string = 'utf8') => {
    if (!isReady) return null;
    
    try {
      const data = localStorage.getItem(`pds_file_${filename}`);
      console.log(`üìñ [WEB] Dosya okundu: ${filename}`, data ? `${data.length} karakter` : 'Bulunamadƒ±');
      return data;
    } catch (error) {
      console.error(`‚ùå [WEB] Dosya okuma hatasƒ± (${filename}):`, error);
      return null;
    }
  }, [isReady]);

  // Dosya var mƒ± kontrol et
  const fileExists = useCallback(async (filename: string) => {
    if (!isReady) return false;
    
    const exists = localStorage.getItem(`pds_file_${filename}`) !== null;
    console.log(`üîç [WEB] Dosya varlƒ±k kontrol√º: ${filename} = ${exists}`);
    return exists;
  }, [isReady]);

  // Uygulama bilgilerini al
  const getAppInfo = useCallback(async () => {
    return {
      version: '1.0.0-web',
      name: 'Personel Destek Sistemi (Web)',
      dataPath: 'localStorage',
      isDev: import.meta.env.DEV
    };
  }, []);

  // Web i√ßin veri dƒ±≈üa aktarma
  const exportData = useCallback(async () => {
    try {
      console.log('üì¶ [WEB] Veri dƒ±≈üa aktarƒ±mƒ± ba≈ülatƒ±lƒ±yor...');
      
      // T√ºm PDS verilerini topla
      const exportData: { [key: string]: any } = {};
      const keys = Object.keys(localStorage);
      
      keys.forEach(key => {
        if (key.startsWith('pds_')) {
          const cleanKey = key.replace('pds_', '');
          const value = localStorage.getItem(key);
          if (value) {
            try {
              exportData[cleanKey] = JSON.parse(value);
            } catch {
              exportData[cleanKey] = value; // String olarak sakla
            }
          }
        }
      });
      
      // Veri kontrol√º - bo≈ü export'u engelle
      const dataKeys = Object.keys(exportData).filter(key => key !== '_metadata');
      if (dataKeys.length === 0) {
        console.warn('‚ö†Ô∏è [WEB] Export edilecek veri bulunamadƒ±');
        alert('‚ö†Ô∏è Export edilecek veri bulunamadƒ±.\n\n√ñnce bazƒ± mod√ºllere veri y√ºkleyin.');
        return false;
      }

      // Metadata ekle
      exportData._metadata = {
        exportDate: new Date().toISOString(),
        version: '1.0.0-web',
        platform: 'web',
        userAgent: navigator.userAgent,
        totalModules: dataKeys.length
      };
      
      // JSON dosyasƒ± olarak indir
      const dataStr = JSON.stringify(exportData, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      
      const link = document.createElement('a');
      link.href = URL.createObjectURL(dataBlob);
      link.download = `personel_destek_yedek_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
      link.style.display = 'none';
      document.body.appendChild(link);
      link.click();
      
      // Cleanup
      setTimeout(() => {
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);
      }, 100);
      
      console.log(`üì¶ [WEB] Veri dƒ±≈üa aktarƒ±mƒ± tamamlandƒ± - ${dataKeys.length} mod√ºl`);
      return true;
    } catch (error) {
      console.error('‚ùå [WEB] Dƒ±≈üa aktarƒ±m hatasƒ±:', error);
      alert('‚ùå Dƒ±≈üa aktarƒ±m sƒ±rasƒ±nda hata olu≈ütu:\n' + error.message);
      return false;
    }
  }, []);

  // Web i√ßin veri i√ße aktarma
  const importData = useCallback(async () => {
    return new Promise<boolean>((resolve) => {
      try {
        console.log('üì• [WEB] Veri i√ße aktarƒ±mƒ± ba≈ülatƒ±lƒ±yor...');
        
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.style.display = 'none';
        document.body.appendChild(input);
        
        input.onchange = (e) => {
          const file = (e.target as HTMLInputElement).files?.[0];
          if (!file) {
            document.body.removeChild(input);
            resolve(false);
            return;
          }

          // Dosya boyutu kontrol√º
          if (file.size > 10 * 1024 * 1024) { // 10MB limit
            alert('‚ùå Dosya √ßok b√ºy√ºk (max 10MB)');
            document.body.removeChild(input);
            resolve(false);
            return;
          }
          
          const reader = new FileReader();
          reader.onload = (event) => {
            try {
              const importedData = JSON.parse(event.target?.result as string);
              
              // Veri formatƒ± kontrol√º
              if (!importedData || typeof importedData !== 'object') {
                alert('‚ùå Ge√ßersiz JSON formatƒ±');
                document.body.removeChild(input);
                resolve(false);
                return;
              }

              // Mevcut verileri yedekle
              const backup: { [key: string]: string | null } = {};
              const keys = Object.keys(localStorage);
              keys.forEach(key => {
                if (key.startsWith('pds_')) {
                  backup[key] = localStorage.getItem(key);
                }
              });
              
              try {
                // Yeni verileri y√ºkle
                let importedCount = 0;
                Object.keys(importedData).forEach(key => {
                  if (key === '_metadata') return; // Metadata'yƒ± atla
                  
                  const value = importedData[key];
                  const storageKey = `pds_${key}`;
                  
                  if (typeof value === 'object') {
                    localStorage.setItem(storageKey, JSON.stringify(value));
                  } else {
                    localStorage.setItem(storageKey, value);
                  }
                  importedCount++;
                });
                
                console.log(`üì• [WEB] ${importedCount} mod√ºl verisi i√ße aktarƒ±ldƒ±`);
              } catch (storageError) {
                // Hata durumunda backup'ƒ± geri y√ºkle
                Object.keys(backup).forEach(key => {
                  if (backup[key] !== null) {
                    localStorage.setItem(key, backup[key]!);
                  }
                });
                throw storageError;
              }
              
              document.body.removeChild(input);
              console.log('üì• [WEB] Veri i√ße aktarƒ±mƒ± ba≈üarƒ±yla tamamlandƒ±');
              resolve(true);
            } catch (error) {
              console.error('‚ùå [WEB] ƒ∞√ße aktarƒ±m parse hatasƒ±:', error);
              alert('‚ùå ƒ∞√ße aktarƒ±m hatasƒ±:\n' + error.message);
              document.body.removeChild(input);
              resolve(false);
            }
          };
          
          reader.onerror = () => {
            console.error('‚ùå [WEB] Dosya okuma hatasƒ±');
            alert('‚ùå Dosya okunamadƒ±');
            document.body.removeChild(input);
            resolve(false);
          };
          
          reader.readAsText(file);
        };
        
        // ƒ∞ptal durumu i√ßin timeout
        setTimeout(() => {
          if (document.body.contains(input)) {
            document.body.removeChild(input);
            resolve(false);
          }
        }, 30000); // 30 saniye timeout
        
        input.click();
      } catch (error) {
        console.error('‚ùå [WEB] ƒ∞√ße aktarƒ±m hatasƒ±:', error);
        alert('‚ùå ƒ∞√ße aktarƒ±m ba≈ülatƒ±lamadƒ±:\n' + error.message);
        resolve(false);
      }
    });
  }, []);

  return {
    isReady,
    isElectron: false, // Web ortamƒ±
    readJsonFile,
    writeJsonFile,
    updateYayinDurumu,
    saveFile,
    readFile,
    fileExists,
    getAppInfo,
    exportData,
    importData
  };
};